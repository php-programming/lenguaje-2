# 10.3 Rutas Personalizadas

El concepto de Rutas Personalizadas implica que el desarrollador define explícitamente un mapa donde se especifica: "Si el usuario pide esta URL exacta, entonces ejecuta este Controlador y esta Acción".

## Concepto Teórico: Mapeo Explícito

En lugar de que el sistema analice la URL dinámicamente, usaremos un array de configuración para guardar las rutas deseadas.

- **Ruta Definida (Pattern)**: `/productos/ofertas` (La URL que el usuario ve)
- **Destino Interno (Target)**: `ProductoController@ofertas` (El Controlador y la Acción que se ejecutan)

Esto permite crear URLs que no coinciden directamente con los nombres de nuestras clases y métodos, mejorando la SEO y la abstracción.

## Implementación Práctica: Mejorando la Clase Router

Modificaremos la clase `Router` para que, antes de intentar la convención (Unidad V), compruebe si la URL solicitada coincide con alguna de las rutas personalizadas definidas.

### a. Archivo de Configuración de Rutas (`rutas.php`):

Definiremos un array que contenga el mapeo.

```php
<?php
// config/rutas.php

// Definición de las rutas personalizadas
// Clave: El patrón de la URL (lo que el usuario escribe)
// Valor: El destino (Controlador@Accion)
return [
    // 1. Ruta Estática Simple
    'inicio' => 'InicioController@index',

    // 2. Ruta con nombre diferente al controlador
    'articulos-en-oferta' => 'ProductoController@obtenerOfertas',

    // 3. Ruta con Parámetro Dinámico (usamos un marcador como {id})
    // El router debe ser lo suficientemente inteligente para manejar esto.
    'producto/detalle/{id}' => 'ProductoController@verDetalle',

    // 4. Ruta para API (ej. JSON)
    'api/productos' => 'ProductoController@apiListar',
];
```

### b. Modificación de la Clase `Router.php` (Método `procesarRuta()`):

Necesitamos un nuevo método que cargue estas rutas y busque una coincidencia.

```php
<?php
// core/Router.php (Modificado)

class Router {

    // ... propiedades ya definidas ...
    protected $rutasPersonalizadas = [];

    public function __construct() {
        $this->cargarRutasPersonalizadas();
        $this->procesarRuta();
    }

    protected function cargarRutasPersonalizadas() {
        // Cargar el array de rutas desde el archivo de configuración
        $this->rutasPersonalizadas = require_once '../config/rutas.php';
    }

    protected function obtenerUrl() {
        // ... misma lógica de la Unidad V ...
        return isset($_GET['url']) ? explode('/', filter_var(rtrim($_GET['url'], '/'), FILTER_SANITIZE_URL)) : [];
    }

    protected function procesarRuta() {
        $url_segmentos = $this->obtenerUrl();
        $url_actual = implode('/', $url_segmentos);

        // Buscar coincidencia exacta o con parámetros
        foreach ($this->rutasPersonalizadas as $patron => $destino) {
            // Lógica simplificada de coincidencia (en un framework real se usan expresiones regulares)
            if ($url_actual == $patron) {
                $partes = explode('@', $destino);
                $this->controlador = $partes[0]; // Nombre del controlador (sin 'Controller' si así se define)
                $this->accion = $partes[1];
                return;
            }
        }
        
        // Si no hay coincidencia personalizada, sigue la lógica por defecto (Convención)
        if ($url_segmentos && isset($url_segmentos[0])) {
            $this->controlador = ucwords($url_segmentos[0]);
            unset($url_segmentos[0]);
        }
        // ... resto de la lógica por defecto ...
    }

    // El método despachar() permanece igual.

}
?>
```

## Ejemplo de Funcionamiento

| URL Solicitada          | Ruta Procesada (Patrón) | Controlador a Ejecutar | Acción a Ejecutar | Parámetros |
| :---------------------- | :---------------------- | :--------------------- | :---------------- | :--------- |
| `/articulos-en-oferta`  | `articulos-en-oferta`   | `ProductoController`   | `obtenerOfertas`  | `[]`       |
| `/producto/detalle/123` | `producto/detalle/{id}` | `ProductoController`   | `verDetalle`      | `[123]`    |
| `/usuario/perfil`       | (No coincide)           | `UsuarioController`    | `perfil`          | `[]`       |

## Ventajas de las Rutas Personalizadas

- **Flexibilidad**: Permite cambiar la URL sin modificar la lógica interna de los controladores (ej. cambiar `/producto/lista` por `/catalogo`).
- **Claridad**: El archivo `rutas.php` sirve como documentación de todas las URLs disponibles en la aplicación.
- **Control de Acceso**: Facilita la aplicación de middleware o restricciones de seguridad antes de ejecutar el controlador.
