# 10.2 Método de Enrutamiento (Routing)

El **Método de Enrutamiento** (o Router) es el componente central de control de flujo de nuestro framework. Su trabajo es traducir la URL legible por el usuario en una instrucción interna para la aplicación (Controlador $\to$ Acción).

## Pre-requisito: URL Amigables y `.htaccess`

Para que PHP pueda procesar cualquier URL (ej. `/productos/ver/5`), primero necesitamos una configuración en el servidor web (generalmente Apache o Nginx) para redirigir todas las peticiones a un único archivo de entrada (usualmente `index.php`). Esto se conoce como el patrón **Front Controller**.

En Apache, esto se logra con el archivo `.htaccess` en la carpeta principal:

```apache
# .htaccess
<IfModule mod_rewrite.c>
    RewriteEngine On
    # Regla: Si la petición NO es un archivo existente
    RewriteCond %{REQUEST_FILENAME} !-f
    # Regla: Si la petición NO es un directorio existente
    RewriteCond %{REQUEST_FILENAME} !-d
    # Redirige todo el tráfico a index.php,
    # y pasa la URL original como parámetro 'url'
    RewriteRule ^(.*)$ index.php?url=$1 [QSA, L]
</IfModule>
```

**Efecto**: Si el usuario accede a `midominio.com/producto/lista`, el servidor internamente llama a `index.php?url=producto/lista`. PHP ahora tiene la cadena clave `producto/lista` para trabajar.

## Implementación Práctica: El Parser de URL en PHP

El corazón del enrutamiento es una lógica que toma la cadena de la URL y la descompone.

### a. Definición de la Clase `Router.php`:

Crearemos una clase simple que se encargue de este proceso. La incluiremos en la carpeta `core/` junto a `Autoload.php`.

```php
<?php
// core/Router.php

class Router {

    // Propiedades que guardarán el controlador y la acción extraídos
    protected $controlador = 'Inicio'; // Controlador por defecto
    protected $accion = 'index';      // Acción por defecto
    protected $parametros = [];       // Parámetros de la URL

    public function __construct() {
        // 1. Obtener la cadena de la URL
        $url = $this->obtenerUrl();

        // 2. Procesar y Asignar
        if ($url && isset($url[0])) {
            $this->controlador = ucwords($url[0]);
            unset($url[0]);
        }

        if ($url && isset($url[1])) {
            $this->accion = $url[1];
            unset($url[1]);
        }

        $this->parametros = $url ? array_values($url) : [];
    }

    protected function obtenerUrl() {
        if (isset($_GET['url'])) {
            return explode('/', filter_var(rtrim($_GET['url'], '/'), FILTER_SANITIZE_URL));
        }
        return [];
    }

    public function despachar() {
        // Formatear el nombre de la clase Controlador (ej: 'Producto' -> 'ProductoController')
        $nombre_controlador = $this->controlador . 'Controller';

        // Verificar si la clase existe (gracias al Autoload)
        if (class_exists($nombre_controlador)) {
            $controlador_instancia = new $nombre_controlador();

            // Verificar si el método (acción) existe en el controlador
            if (method_exists($controlador_instancia, $this->accion)) {
                // Ejecutar la acción pasando los parámetros
                call_user_func_array([$controlador_instancia, $this->accion], $this->parametros);
            } else {
                echo "Error: La acción '{$this->accion}' no existe en el controlador.";
            }
        } else {
            echo "Error: El controlador '{$nombre_controlador}' no existe.";
        }
    }
}
?>
```

### b. Conexión y Flujo en `index.php`

El punto de entrada (`index.php`) es el único lugar donde se usa el Router.

```php
<?php
// public/index.php

// 1. Inicialización (Autoload ya está cargado de la Unidad IV)
require_once '../core/Autoload.php';
require_once '../core/Router.php';

// 2. Creación y Despacho
$router = new Router();
$router->despachar();

// --- FLUJO DE EJECUCIÓN ---
// URL: midominio.com/producto/crear/100
// Router obtiene: ['producto', 'crear', '100']
// Router asigna:
//   - Controlador: 'Producto' -> ProductoController
//   - Acción: 'crear'
//   - Parámetros: ['100']
// Router ejecuta: $controladorProducto->crear(100);
?>
```

## Conclusión

Hemos implementado un Método de Enrutamiento funcional que:

- Depende del archivo `.htaccess` para redirigir todas las peticiones a `index.php`.
- Utiliza la clase `Router` para analizar la URL (Parsing).
- Determina el Controlador y la Acción a ejecutar.
- Llama al método correcto utilizando POO y la función `call_user_func_array`.
