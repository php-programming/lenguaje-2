# 14.4 Integración Simplificada de AJAX y PHP

## Caso de Uso

**Escenario:** Un formulario de "Suscripción al Newsletter" en el pie de página.
**Requisito:** El usuario debe poder suscribirse sin que la página se recargue y pierda su posición de lectura. El servidor debe validar el email y devolver una respuesta JSON.

---

## El Flujo de Datos Asíncrono

### 1. El Backend (PHP)

Primero, necesitamos un endpoint que hable JSON. En nuestro MVC, esto es una acción de controlador.

```php
// controladores/SuscripcionController.php

public function suscribir() {
    // 1. Recibir datos (Payload JSON)
    // Cuando se usa fetch con 'application/json', $_POST no funciona directamente.
    $json = file_get_contents('php://input');
    $datos = json_decode($json, true);
    
    $email = $datos['email'] ?? '';

    // 2. Procesar
    $respuesta = [];
    if (filter_var($email, FILTER_VALIDATE_EMAIL)) {
        // (Aquí guardaríamos en BD)
        $respuesta['exito'] = true;
        $respuesta['mensaje'] = '¡Gracias por suscribirte!';
    } else {
        $respuesta['exito'] = false;
        $respuesta['mensaje'] = 'Email inválido.';
    }

    // 3. Responder JSON
    header('Content-Type: application/json');
    echo json_encode($respuesta);
    exit;
}
```

### 2. El Frontend (JavaScript)

Usamos `fetch` para enviar los datos y procesar la respuesta.

```javascript
// assets/js/newsletter.js

const form = document.getElementById('form-newsletter');

form.addEventListener('submit', function(e) {
    e.preventDefault(); // DETENER el envío tradicional

    const emailInput = document.getElementById('email-input').value;

    // Configuración de la petición
    const opciones = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email: emailInput })
    };

    // Ejecución
    fetch('index.php?url=suscripcion/suscribir', opciones)
        .then(response => response.json()) // Parsear respuesta del servidor
        .then(data => {
            if (data.exito) {
                alert(data.mensaje); // UX: Feedback positivo
                form.reset();
            } else {
                alert('Error: ' + data.mensaje); // UX: Feedback negativo
            }
        })
        .catch(error => console.error('Error de red:', error));
});
```

## Resumen de Arquitectura

1.  **JS:** Captura evento `submit` -> `e.preventDefault()`.
2.  **JS:** Empaqueta datos en JSON -> `fetch()`.
3.  **PHP:** Recibe JSON (`php://input`) -> Procesa -> Devuelve JSON.
4.  **JS:** Recibe JSON -> Actualiza UI (Alertas/DOM).

Esta integración desacoplada es la base de las interfaces modernas.
